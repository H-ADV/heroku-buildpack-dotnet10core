#!/usr/bin/env bash
# bin/release <build-dir>

### Configure directories

export BUILD_DIR=$1
BP_DIR=$(cd $(dirname $0)/..; pwd)

### Load dependencies

# shellcheck source=util/common.sh
source "$BP_DIR/bin/util/common.sh"

### Export all env vars here
. $BUILD_DIR/.profile.d/dotnetcore.sh

cat <<EOF
---
config_vars:
EOF

#if [[ $IS_POSTGRES_USED == "yes" ]]; then
#cat <<EOF
#addons:
#  - heroku-postgresql:hobby-dev
#EOF
#fi

# Determine project paths for migration
INFRA_PROJECT=$(find $BUILD_DIR -name "*.Infrastructure.csproj" | head -n 1)
WEB_PROJECT=$(find $BUILD_DIR -name "*.WebAPI.csproj" | head -n 1)

RELEASE_CMD=""
if [[ -n "$INFRA_PROJECT" && -n "$WEB_PROJECT" ]]; then
    # Construct the release command
    # Added ls -la for debugging
    RELEASE_CMD="release: cd \$HOME && echo \"Current Dir:\" && pwd && echo \"Listing Home:\" && ls -la && echo \"Listing Out:\" && ls -la $RELEASE_DIR && dotnet ef database update --project \"\$(find . -name *.Infrastructure.csproj | head -n 1)\" --startup-project \"\$(find . -name *.WebAPI.csproj | head -n 1)\""
fi

if [[ ! -f $BUILD_DIR/Procfile ]]; then
cat <<EOF
default_process_types:
  web: cd \$HOME/$RELEASE_DIR && echo "Listing Web Dir:" && ls -la && dotnet \"./${APP_ASSEMBLY}.dll\" --urls http://+:\$PORT
EOF

    if [[ -n "$RELEASE_CMD" ]]; then
        echo "  $RELEASE_CMD"
    fi
fi


